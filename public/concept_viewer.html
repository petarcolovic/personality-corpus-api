<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Personality Corpus – Concept Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --primary: #2563eb;
      --primary-soft: #e0ebff;
      --border: #e2e8f0;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --danger: #b91c1c;
      --radius-xl: 16px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.08);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #e0f2fe 0, #f5f7fb 45%, #e2e8f0 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 20px 48px;
    }

    .header {
      margin-bottom: 24px;
    }

    .title {
      font-size: 32px;
      margin: 0 0 4px;
      letter-spacing: 0.02em;
    }

    .subtitle {
      margin: 0;
      font-size: 15px;
      color: var(--text-muted);
    }

    .card {
      background: var(--card-bg);
      border-radius: 24px;
      box-shadow: var(--shadow-soft);
      padding: 24px 28px 26px;
      border: 1px solid rgba(148, 163, 184, 0.12);
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 12px;
      align-items: flex-end;
    }

    .field {
      flex: 1 1 240px;
      min-width: 0;
    }

    .field-label {
      display: block;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .select,
    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 14px;
      outline: none;
      background: #ffffff;
      color: var(--text-main);
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
      appearance: none;
    }

    .select:focus,
    .input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
      background: #f9fbff;
    }

    .button {
      padding: 11px 26px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      font-weight: 600;
      background: var(--primary);
      color: #ffffff;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 14px 30px rgba(37, 99, 235, 0.25);
      transition: background 0.15s ease, box-shadow 0.15s ease, transform 0.08s ease;
    }

    .button:hover {
      background: #1d4ed8;
      box-shadow: 0 16px 38px rgba(37, 99, 235, 0.3);
      transform: translateY(-1px);
    }

    .button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .meta-text {
      font-size: 11px;
      color: var(--text-muted);
      margin: 4px 0 10px;
    }

    .meta-text code {
      font-family: "SF Mono", Menlo, Monaco, Consolas, monospace;
      font-size: 11px;
      background: #f1f5f9;
      padding: 2px 5px;
      border-radius: 6px;
    }

    .status-line {
      font-size: 13px;
      min-height: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      color: var(--text-muted);
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--primary);
    }

    .status-error {
      color: var(--danger);
    }

    .status-error .status-dot {
      background: var(--danger);
    }

    .docs-link {
      font-size: 12px;
      color: var(--text-muted);
    }

    .docs-link a {
      color: var(--primary);
      text-decoration: none;
    }

    .docs-link a:hover {
      text-decoration: underline;
    }

    .results-card {
      margin-top: 20px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.24);
      padding: 14px 18px;
      max-height: 420px;
      overflow: auto;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .results-title {
      font-weight: 600;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 11px;
      font-weight: 500;
      gap: 4px;
    }

    .result-item {
      padding: 8px 0;
      border-bottom: 1px solid rgba(226, 232, 240, 0.7);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .lemma-head {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      font-size: 14px;
    }

    .lemma-word {
      font-weight: 600;
    }

    .lemma-lang {
      font-size: 12px;
      color: var(--text-muted);
    }

    .lemma-def {
      margin-top: 4px;
      font-size: 13px;
      color: var(--text-main);
    }

    .lemma-meta {
      margin-top: 4px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .pagination {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      font-size: 12px;
    }

    .page-btn {
      border: 1px solid var(--border);
      background: #ffffff;
      border-radius: 999px;
      padding: 4px 9px;
      cursor: pointer;
      font-size: 12px;
    }

    .page-btn:disabled {
      opacity: 0.5;
      cursor: default;
    }

    .page-info {
      color: var(--text-muted);
    }

    @media (max-width: 720px) {
      .page {
        padding: 20px 12px 32px;
      }

      .card {
        padding: 18px 16px 20px;
      }

      .title {
        font-size: 24px;
      }

      .filters-row {
        flex-direction: column;
        align-items: stretch;
      }

      .button {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <header class="header">
    <h1 class="title">Personality Corpus – Concept Viewer</h1>
    <p class="subtitle">
      Browse lemmas grouped by language for one kernel concept.
    </p>
  </header>

  <main class="card">
    <section>
      <div class="filters-row">
        <div class="field">
          <label class="field-label" for="kernelSelect">Kernel word</label>
          <select id="kernelSelect" class="select">
            <option value="">Loading kernels…</option>
          </select>
        </div>

        <div class="field">
          <label class="field-label" for="languageSelect">Language</label>
          <select id="languageSelect" class="select">
            <option value="">All languages</option>
          </select>
        </div>

        <button id="searchButton" class="button">
          <span>Search</span>
        </button>
      </div>

      <p class="meta-text">
        Kernels are loaded from <code>/kernels</code>. Languages are loaded from <code>/languages</code>.
        Data per kernel comes from <code>/lemmas/by_kernel/&lt;kernel_word&gt;</code>.
      </p>

      <div id="statusLine" class="status-line">
        <div class="status-left">
          <span class="status-dot"></span>
          <span id="statusText">Ready.</span>
        </div>
        <div class="docs-link">
          API docs: <a href="https://personality-corpus-api-production.up.railway.app/docs" target="_blank" rel="noopener">/docs</a>
        </div>
      </div>
    </section>

    <section id="resultsSection" class="results-card" style="display:none;">
      <div class="results-header">
        <div class="results-title" id="resultsTitle">Results</div>
        <div class="badge" id="resultsBadge">0 items</div>
      </div>
      <div id="resultsContainer"></div>
      <div class="pagination" id="pagination" style="display:none;">
        <button id="prevPage" class="page-btn">Prev</button>
        <span class="page-info" id="pageInfo"></span>
        <button id="nextPage" class="page-btn">Next</button>
      </div>
    </section>
  </main>
</div>

<script>
  const API_BASE = "https://personality-corpus-api-production.up.railway.app";

  const kernelSelect = document.getElementById("kernelSelect");
  const languageSelect = document.getElementById("languageSelect");
  const searchButton = document.getElementById("searchButton");
  const statusLine = document.getElementById("statusLine");
  const statusText = document.getElementById("statusText");
  const resultsSection = document.getElementById("resultsSection");
  const resultsContainer = document.getElementById("resultsContainer");
  const resultsTitle = document.getElementById("resultsTitle");
  const resultsBadge = document.getElementById("resultsBadge");
  const pagination = document.getElementById("pagination");
  const prevPageBtn = document.getElementById("prevPage");
  const nextPageBtn = document.getElementById("nextPage");
  const pageInfo = document.getElementById("pageInfo");

  let currentPage = 1;
  const PAGE_SIZE = 50;
  let lastQuery = null;

  function setStatus(message, isError = false) {
    statusText.textContent = message;
    if (isError) {
      statusLine.classList.add("status-error");
    } else {
      statusLine.classList.remove("status-error");
    }
  }

  function setLoading(isLoading) {
    searchButton.disabled = isLoading;
    searchButton.textContent = isLoading ? "Loading…" : "Search";
  }

  async function loadFilters() {
    setStatus("Loading kernels and languages…");
    try {
      const [kernelsRes, languagesRes] = await Promise.all([
        fetch(`${API_BASE}/kernels`),
        fetch(`${API_BASE}/languages`)
      ]);

      if (!kernelsRes.ok || !languagesRes.ok) {
        throw new Error(`Kernels status ${kernelsRes.status}, languages status ${languagesRes.status}`);
      }

      const kernels = await kernelsRes.json();      // plain array
      const languages = await languagesRes.json();  // plain array

      // Populate kernels
      kernelSelect.innerHTML = "";
      kernels
        .sort((a, b) => a.kernel.localeCompare(b.kernel))
        .forEach(k => {
          const opt = document.createElement("option");
          opt.value = k.kernel;
          opt.textContent = k.kernel;
          kernelSelect.appendChild(opt);
        });

      // Populate languages
      languageSelect.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "";
      allOpt.textContent = "All languages";
      languageSelect.appendChild(allOpt);

      languages
        .sort((a, b) => a.name.localeCompare(b.name))
        .forEach(lang => {
          const opt = document.createElement("option");
          opt.value = lang.prefix; // prefix, npr. ENG, SLO…
          opt.textContent = lang.name;
          languageSelect.appendChild(opt);
        });

      setStatus("Filters loaded. Choose a kernel and press Search.");
    } catch (err) {
      console.error("Error loading filters", err);
      setStatus("Error loading filters: Failed to load kernels or languages.", true);
    }
  }

  async function fetchLemmasForKernel({ kernel, langPrefix, page }) {
    const params = new URLSearchParams();
    if (langPrefix) params.append("lang_prefix", langPrefix);
    params.append("page", page);
    params.append("page_size", PAGE_SIZE);

    const url = `${API_BASE}/lemmas/by_kernel/${encodeURIComponent(kernel)}?${params.toString()}`;
    const res = await fetch(url);
    if (!res.ok) {
      throw new Error(`Lemma request failed with status ${res.status}`);
    }
    return res.json(); // očekujemo {items, total, page, page_size}
  }

  function renderResults(data, kernel, langPrefix) {
    const items = data.items || [];
    const total = data.total ?? items.length;
    const page = data.page ?? 1;
    const pageSize = data.page_size ?? items.length;

    resultsContainer.innerHTML = "";

    if (!items.length) {
      resultsContainer.innerHTML = "<p style='font-size:13px;color:#64748b;'>No lemmas found for this kernel/language combination.</p>";
      resultsBadge.textContent = "0 items";
      pagination.style.display = "none";
      return;
    }

    items.forEach(item => {
      const div = document.createElement("div");
      div.className = "result-item";

      const examplesText = item.examples && item.examples.length
        ? item.examples.join(" · ")
        : "";

      div.innerHTML = `
        <div class="lemma-head">
          <div class="lemma-word">${item.lemma}</div>
          <div class="lemma-lang">${item.lang_name || ""} (${item.lang_prefix || ""})</div>
        </div>
        <div class="lemma-def">${item.definition || ""}</div>
        <div class="lemma-meta">
          ID: ${item.id ?? "–"}
          ${examplesText ? ` · Examples: ${examplesText}` : ""}
        </div>
      `;
      resultsContainer.appendChild(div);
    });

    resultsTitle.textContent = `Kernel "${kernel}"${langPrefix ? ` · ${langPrefix}` : ""}`;
    resultsBadge.textContent = `${total} items total`;

    // Pagination controls
    const totalPages = Math.max(1, Math.ceil(total / pageSize));
    pagination.style.display = totalPages > 1 ? "flex" : "none";
    currentPage = page;
    pageInfo.textContent = `Page ${page} of ${totalPages}`;
    prevPageBtn.disabled = page <= 1;
    nextPageBtn.disabled = page >= totalPages;
  }

  async function runSearch(page = 1) {
    const kernel = kernelSelect.value;
    const langPrefix = languageSelect.value || "";

    if (!kernel) {
      setStatus("Please choose a kernel word first.", true);
      return;
    }

    setLoading(true);
    setStatus("Loading lemmas…");
    resultsSection.style.display = "block";

    if (!lastQuery) {
      lastQuery = {};
    }
    lastQuery.kernel = kernel;
    lastQuery.langPrefix = langPrefix;

    try {
      const data = await fetchLemmasForKernel({ kernel, langPrefix, page });
      renderResults(data, kernel, langPrefix);
      setStatus("Results loaded.");
    } catch (err) {
      console.error("Search error", err);
      setStatus("Error loading lemmas for selected kernel/language.", true);
    } finally {
      setLoading(false);
    }
  }

  // Event handlers
  searchButton.addEventListener("click", () => runSearch(1));

  prevPageBtn.addEventListener("click", () => {
    if (!lastQuery || currentPage <= 1) return;
    runSearch(currentPage - 1);
  });

  nextPageBtn.addEventListener("click", () => {
    if (!lastQuery) return;
    runSearch(currentPage + 1);
  });

  // Init
  loadFilters();
</script>
</body>
</html>
