<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Personality Corpus – Concept Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --accent: #2563eb;
      --accent-soft: #e0ecff;
      --text: #111827;
      --muted: #6b7280;
      --border: #e5e7eb;
      --danger: #b91c1c;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top left, #e0ecff, #f9fafb 55%);
      min-height: 100vh;
      color: var(--text);
    }

    .page {
      max-width: 1100px;
      margin: 0 auto;
      padding: 32px 16px 40px;
    }

    header h1 {
      margin: 0 0 4px;
      font-size: 1.9rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    header p {
      margin: 0;
      font-size: 0.95rem;
      color: var(--muted);
    }

    .card {
      margin-top: 24px;
      background: var(--card-bg);
      border-radius: 18px;
      box-shadow: 0 22px 45px rgba(15, 23, 42, 0.12);
      padding: 20px 22px 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    .filters {
      display: grid;
      grid-template-columns: minmax(0, 1.5fr) minmax(0, 1fr) auto;
      gap: 12px;
      align-items: end;
    }

    label {
      display: block;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 4px;
      font-weight: 600;
    }

    select,
    input[type="text"] {
      width: 100%;
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      outline: none;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
    }

    select:focus,
    input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px var(--accent-soft);
      background: #ffffff;
    }

    button.primary {
      padding: 9px 18px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #2563eb, #1d4ed8);
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 25px rgba(37, 99, 235, 0.4);
      white-space: nowrap;
    }

    button.primary:hover {
      filter: brightness(1.04);
      transform: translateY(-0.5px);
    }

    button.primary:active {
      transform: translateY(0.5px);
      box-shadow: 0 6px 16px rgba(37, 99, 235, 0.35);
    }

    .hint {
      margin-top: 10px;
      font-size: 0.78rem;
      color: var(--muted);
    }

    .hint code {
      background: #f3f4ff;
      padding: 2px 5px;
      border-radius: 4px;
      font-size: 0.78rem;
    }

    .status {
      margin-top: 10px;
      font-size: 0.8rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .status-main {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pill-error {
      color: var(--danger);
      background: #fee2e2;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.78rem;
    }

    .pill-ok {
      color: #065f46;
      background: #d1fae5;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.78rem;
    }

    .status a {
      font-size: 0.8rem;
      color: var(--accent);
      text-decoration: none;
    }

    .status a:hover {
      text-decoration: underline;
    }

    .results {
      margin-top: 18px;
      border-top: 1px solid var(--border);
      padding-top: 14px;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .results-header strong {
      color: var(--text);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th,
    td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--muted);
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .lemma {
      font-weight: 600;
    }

    .lang-tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 7px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .json-blob {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      background: #f9fafb;
      border-radius: 8px;
      padding: 6px 8px;
      max-height: 180px;
      overflow: auto;
      color: #4b5563;
    }

    @media (max-width: 800px) {
      .filters {
        grid-template-columns: 1fr;
      }
      .results-header {
        align-items: flex-start;
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header>
      <h1>Personality Corpus – Concept Viewer</h1>
      <p>Browse lemmas grouped by language for one kernel concept.</p>
    </header>

    <section class="card">
      <div class="filters">
        <div>
          <label for="kernel-select">Kernel word</label>
          <select id="kernel-select">
            <option value="">Loading kernels…</option>
          </select>
        </div>

        <div>
          <label for="language-select">Language</label>
          <select id="language-select">
            <option value="">Loading languages…</option>
          </select>
        </div>

        <div>
          <button id="search-btn" class="primary">
            Search
          </button>
        </div>
      </div>

      <p class="hint">
        Kernels are loaded from <code>/kernels</code>. Languages are loaded
        from <code>/languages</code>. Data per kernel comes from
        <code>/lemmas/by_kernel/&lt;kernel_word&gt;</code>.
      </p>

      <div class="status" id="status-bar">
        <div class="status-main">
          <span id="status-pill" class="pill-ok">Ready.</span>
        </div>
        <div>
          API docs:
          <a
            href="https://personality-corpus-api-production.up.railway.app/docs"
            target="_blank"
            rel="noopener noreferrer"
            >/docs</a
          >
        </div>
      </div>

      <div class="results" id="results" hidden>
        <div class="results-header">
          <div>
            <strong id="results-title"></strong>
            <span id="results-meta"></span>
          </div>
        </div>
        <div class="results-body" id="results-body"></div>
      </div>
    </section>
  </div>

  <script>
    const API_BASE =
      "https://personality-corpus-api-production.up.railway.app";

    const kernelSelect = document.getElementById("kernel-select");
    const languageSelect = document.getElementById("language-select");
    const searchBtn = document.getElementById("search-btn");
    const statusBar = document.getElementById("status-bar");
    const statusPill = document.getElementById("status-pill");
    const resultsBlock = document.getElementById("results");
    const resultsTitle = document.getElementById("results-title");
    const resultsMeta = document.getElementById("results-meta");
    const resultsBody = document.getElementById("results-body");

    function setStatusOk(msg) {
      statusPill.className = "pill-ok";
      statusPill.textContent = msg;
    }

    function setStatusError(msg) {
      statusPill.className = "pill-error";
      statusPill.textContent = msg;
    }

    async function fetchJSON(url) {
      const resp = await fetch(url);
      if (!resp.ok) {
        throw new Error(`HTTP ${resp.status} for ${url}`);
      }
      return resp.json();
    }

    async function loadFilters() {
      setStatusOk("Loading kernels and languages…");
      try {
        // OVDE je glavna promena: koristimo /kernels i /languages
        const [kernels, languages] = await Promise.all([
          fetchJSON(`${API_BASE}/kernels`),
          fetchJSON(`${API_BASE}/languages`),
        ]);

        // Popuni kernels select
        kernelSelect.innerHTML = "";
        const kernelPlaceholder = document.createElement("option");
        kernelPlaceholder.value = "";
        kernelPlaceholder.textContent = "Select a kernel…";
        kernelPlaceholder.disabled = true;
        kernelPlaceholder.selected = true;
        kernelSelect.appendChild(kernelPlaceholder);

        kernels.forEach((k) => {
          const opt = document.createElement("option");
          const label =
            k.kernel_word || k.word || k.name || JSON.stringify(k);
          opt.value = label;
          opt.textContent = label;
          kernelSelect.appendChild(opt);
        });

        // Popuni languages select
        languageSelect.innerHTML = "";
        const allOpt = document.createElement("option");
        allOpt.value = "";
        allOpt.textContent = "All languages";
        languageSelect.appendChild(allOpt);

        languages.forEach((lang) => {
          const opt = document.createElement("option");
          const prefix =
            lang.prefix || lang.code || lang.iso || lang.iso_639_1;
          const name = lang.name || lang.label || prefix;
          opt.value = prefix || name;
          opt.textContent = prefix ? `${name} (${prefix})` : name;
          languageSelect.appendChild(opt);
        });

        setStatusOk("Filters loaded. Ready.");
      } catch (err) {
        console.error("Error loading filters", err);
        setStatusError(
          "Error loading filters: Failed to load kernels or languages."
        );
      }
    }

    function renderResults(kernelWord, languagePrefix, lemmasRaw) {
      resultsBlock.hidden = false;

      const lemmasArray = Array.isArray(lemmasRaw)
        ? lemmasRaw
        : lemmasRaw.items || [];

      const filtered =
        languagePrefix && languagePrefix !== ""
          ? lemmasArray.filter((l) => {
              const lp =
                l.language_prefix ||
                l.lang_prefix ||
                l.language ||
                l.lang;
              return lp === languagePrefix;
            })
          : lemmasArray;

      resultsTitle.textContent = `Results for “${kernelWord}”`;
      resultsMeta.textContent = ` – ${filtered.length} lemma(s)${
        filtered.length !== lemmasArray.length ? " (filtered by language)" : ""
      }`;

      if (filtered.length === 0) {
        resultsBody.innerHTML =
          '<p style="font-size:0.85rem;color:#6b7280;">No lemmas found for this combination.</p>';
        return;
      }

      let html = "<table><thead><tr>";
      html += "<th>Lemma</th><th>Language</th><th>Raw data</th>";
      html += "</tr></thead><tbody>";

      filtered.forEach((l) => {
        const lemmaText =
          l.lemma || l.form || l.word || l.text || JSON.stringify(l);
        const langPrefix =
          l.language_prefix ||
          l.lang_prefix ||
          l.language ||
          l.lang ||
          "";
        const langName = l.language_name || l.language || "";

        html += "<tr>";
        html += `<td class="lemma">${escapeHtml(lemmaText)}</td>`;
        html += `<td><span class="lang-tag">${escapeHtml(
          langPrefix || "?"
        )}${
          langName ? `·${escapeHtml(langName)}` : ""
        }</span></td>`;
        html += `<td><div class="json-blob">${escapeHtml(
          JSON.stringify(l)
        )}</div></td>`;
        html += "</tr>";
      });

      html += "</tbody></table>";
      resultsBody.innerHTML = html;
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    async function handleSearch() {
      const kernelWord = kernelSelect.value.trim();
      const langPrefix = languageSelect.value;

      if (!kernelWord) {
        setStatusError("Please select a kernel word first.");
        kernelSelect.focus();
        return;
      }

      setStatusOk("Loading lemmas for selected kernel…");
      resultsBlock.hidden = true;
      resultsBody.innerHTML = "";

      try {
        // Osnovni endpoint za podatke:
        let url = `${API_BASE}/lemmas/by_kernel/${encodeURIComponent(
          kernelWord
        )}`;
        // Ako backend ignoriše parametar, neće smetati:
        if (langPrefix) {
          const sep = url.includes("?") ? "&" : "?";
          url += `${sep}language_prefix=${encodeURIComponent(langPrefix)}`;
        }

        const data = await fetchJSON(url);
        renderResults(kernelWord, langPrefix, data);
        setStatusOk("Results loaded.");
      } catch (err) {
        console.error("Error fetching lemmas", err);
        setStatusError("Error loading data for this kernel.");
        resultsBlock.hidden = true;
      }
    }

    searchBtn.addEventListener("click", handleSearch);
    kernelSelect.addEventListener("change", () => {
      resultsBlock.hidden = true;
      resultsBody.innerHTML = "";
      setStatusOk("Ready.");
    });

    document.addEventListener("DOMContentLoaded", loadFilters);
  </script>
</body>
</html>
