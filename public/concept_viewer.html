<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Personality Corpus – Concept Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Minimalan Tailwind CDN samo zbog brzog layout-a -->
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-slate-50 min-h-screen">
    <div class="max-w-6xl mx-auto px-4 py-10">
      <header class="mb-8">
        <h1 class="text-3xl font-bold text-slate-900 mb-2">
          Personality Corpus – Concept Viewer
        </h1>
        <p class="text-slate-600">
          Browse lemmas grouped by language for one kernel concept.
        </p>
      </header>

      <!-- Filter kartica -->
      <section
        class="bg-white shadow-sm rounded-xl border border-slate-200 p-6 mb-8"
      >
        <div class="flex flex-col gap-4 md:flex-row md:items-end">
          <!-- Kernel -->
          <div class="flex-1">
            <label class="block text-sm font-medium text-slate-700 mb-1">
              KERNEL WORD
            </label>
            <select
              id="kernel-select"
              class="mt-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
              <option value="">Loading kernels…</option>
            </select>
            <p class="mt-1 text-xs text-slate-500">
              Kernels are loaded from <code>/kernels</code>.
              Languages are loaded from <code>/languages</code>. Data per kernel
              comes from <code>/lemmas/by_kernel/&lt;kernel_word&gt;</code>.
            </p>
          </div>

          <!-- Language -->
          <div class="flex-1">
            <label class="block text-sm font-medium text-slate-700 mb-1">
              LANGUAGE
            </label>
            <select
              id="language-select"
              class="mt-1 block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm focus:border-indigo-500 focus:outline-none focus:ring-1 focus:ring-indigo-500"
            >
              <option value="">All languages</option>
            </select>
          </div>

          <!-- Search dugme -->
          <div class="md:ml-4">
            <button
              id="search-button"
              class="inline-flex items-center rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
            >
              Search
            </button>
          </div>
        </div>

        <p
          id="filters-error"
          class="mt-3 text-sm text-red-600 hidden"
        ></p>
      </section>

      <!-- Rezultati -->
      <section
        class="bg-white shadow-sm rounded-xl border border-slate-200 p-6"
      >
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold text-slate-900">
            Lemmas by language
          </h2>
          <a
            href="https://personality-corpus-api-production.up.railway.app/docs"
            target="_blank"
            class="text-xs text-indigo-600 hover:text-indigo-800"
            >API docs: /docs</a
          >
        </div>

        <div id="results-container" class="space-y-4 text-sm text-slate-800">
          <p class="text-slate-500">Choose a kernel and click Search.</p>
        </div>
      </section>
    </div>

    <script>
      // ***** PODESI OVAJ URL NA TVOJ RAILWAY API *****
      const API_BASE = "https://personality-corpus-api-production.up.railway.app";

      const KERNELS_URL = `${API_BASE}/kernels`; // BEZ /paged !
      const LANGUAGES_URL = `${API_BASE}/languages`;

      const kernelsSelect = document.getElementById("kernel-select");
      const languagesSelect = document.getElementById("language-select");
      const searchButton = document.getElementById("search-button");
      const resultsContainer = document.getElementById("results-container");
      const filtersError = document.getElementById("filters-error");

      async function loadFilters() {
        filtersError.classList.add("hidden");
        filtersError.textContent = "";

        try {
          // 1) KERNELS
          const kernelsResp = await fetch(KERNELS_URL);
          if (!kernelsResp.ok) {
            throw new Error(
              `Loading kernels failed with status ${kernelsResp.status}`
            );
          }
          const kernels = await kernelsResp.json();

          kernelsSelect.innerHTML = "";
          if (!Array.isArray(kernels) || kernels.length === 0) {
            kernelsSelect.innerHTML =
              '<option value="">No kernels found</option>';
          } else {
            kernelsSelect.innerHTML =
              '<option value="">Select a kernel…</option>';
            for (const k of kernels) {
              const opt = document.createElement("option");
              opt.value = k.kernel_word || k.word || k.id;
              opt.textContent = k.kernel_word || k.word || k.id;
              kernelsSelect.appendChild(opt);
            }
          }

          // 2) LANGUAGES
          const languagesResp = await fetch(LANGUAGES_URL);
          if (!languagesResp.ok) {
            throw new Error(
              `Loading languages failed with status ${languagesResp.status}`
            );
          }
          const languages = await languagesResp.json();

          languagesSelect.innerHTML =
            '<option value="">All languages</option>';
          if (Array.isArray(languages)) {
            for (const lang of languages) {
              const opt = document.createElement("option");
              opt.value = lang.prefix || lang.iso || lang.id;
              opt.textContent =
                lang.name +
                (lang.prefix ? ` (${lang.prefix})` : lang.iso ? ` (${lang.iso})` : "");
              languagesSelect.appendChild(opt);
            }
          }
        } catch (err) {
          console.error(err);
          filtersError.textContent =
            "Error loading filters: Failed to load kernels or languages.";
          filtersError.classList.remove("hidden");
        }
      }

      async function loadLemmas() {
        const kernelValue = kernelsSelect.value;
        const languageValue = languagesSelect.value;

        if (!kernelValue) {
          resultsContainer.innerHTML =
            '<p class="text-sm text-red-600">Please choose a kernel first.</p>';
          return;
        }

        const url = new URL(`${API_BASE}/lemmas/by_kernel/${encodeURIComponent(
          kernelValue
        )}`);

        if (languageValue) {
          url.searchParams.set("language", languageValue);
        }

        resultsContainer.innerHTML =
          '<p class="text-sm text-slate-500">Loading lemmas…</p>';

        try {
          const resp = await fetch(url.toString());
          if (!resp.ok) {
            throw new Error(`Status ${resp.status}`);
          }
          const data = await resp.json();

          if (!Array.isArray(data) || data.length === 0) {
            resultsContainer.innerHTML =
              '<p class="text-sm text-slate-500">No lemmas found for this kernel.</p>';
            return;
          }

          const byLang = {};
          for (const lemma of data) {
            const lang =
              (lemma.language && lemma.language.prefix) ||
              lemma.lang_prefix ||
              "Unknown";
            if (!byLang[lang]) byLang[lang] = [];
            byLang[lang].push(lemma);
          }

          const parts = [];
          for (const [lang, lemmas] of Object.entries(byLang)) {
            const items = lemmas
              .map((l) => {
                const text = l.lemma || l.word || l.text || "";
                const def =
                  (l.definition && l.definition.text) ||
                  l.definition ||
                  "";
                return `<li class="mb-1"><span class="font-medium">${text}</span>${
                  def ? ` – <span class="text-slate-600">${def}</span>` : ""
                }</li>`;
              })
              .join("");

            parts.push(`
              <div class="border border-slate-200 rounded-lg p-3">
                <h3 class="text-sm font-semibold text-slate-900 mb-2">
                  ${lang} <span class="text-xs text-slate-500">(${lemmas.length} lemmas)</span>
                </h3>
                <ul class="text-sm text-slate-800 list-disc ml-5">
                  ${items}
                </ul>
              </div>
            `);
          }

          resultsContainer.innerHTML = parts.join("");
        } catch (err) {
          console.error(err);
          resultsContainer.innerHTML = `
            <p class="text-sm text-red-600">
              Error loading lemmas: ${err.message}.
            </p>
          `;
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadFilters();
      });

      searchButton.addEventListener("click", (ev) => {
        ev.preventDefault();
        loadLemmas();
      });
    </script>
  </body>
</html>
